import { useEffect, useState, useRef } from 'react';
import { useParams, Link, useSearchParams } from 'react-router-dom';
import { ShieldCheck, AlertTriangle, FileText, ChevronLeft, Calendar, FlaskConical, Download, Settings, Sun, Moon, ShoppingCart, Edit3, User } from 'lucide-react';
import type { COA } from '../types/coa';
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip as ReTooltip, Legend } from 'recharts';
import QRCode from "react-qr-code";
import { toPng } from 'html-to-image';
import CVVGenerator from '../components/CVVGenerator';
import COAEnrichmentForm from '../components/COAEnrichmentForm';
import { useAuth } from '../contexts/AuthContext';
import ClientCOAEditor from '../components/ClientCOAEditor';

// Analytics tracking helper
const trackCOAAccess = async (token: string, accessType: string, linkSource?: string, cvvCode?: string) => {
    try {
        const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000';

        // Get UTM params from URL
        const urlParams = new URLSearchParams(window.location.search);
        const utmParams = {
            utm_source: urlParams.get('utm_source'),
            utm_medium: urlParams.get('utm_medium'),
            utm_campaign: urlParams.get('utm_campaign'),
            utm_content: urlParams.get('utm_content'),
            utm_term: urlParams.get('utm_term')
        };

        await fetch(`${API_URL}/api/v1/analytics/track/${token}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                access_type: accessType,
                link_source: linkSource,
                cvv_code: cvvCode,
                ...utmParams
            })
        });
    } catch (error) {
        console.error('[Analytics] Tracking error:', error);
    }
};

// Track PDF download
const trackPDFDownload = async (token: string, pdfType: string = 'branded') => {
    try {
        const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000';
        await fetch(`${API_URL}/api/v1/analytics/track/${token}/pdf`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pdf_type: pdfType })
        });
    } catch (error) {
        console.error('[Analytics] PDF tracking error:', error);
    }
};

// Track link clicks
const trackLinkClick = async (token: string, linkType: string, linkUrl: string, linkLabel?: string) => {
    try {
        const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000';
        await fetch(`${API_URL}/api/v1/analytics/track/${token}/link`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ link_type: linkType, link_url: linkUrl, link_label: linkLabel })
        });
    } catch (error) {
        console.error('[Analytics] Link tracking error:', error);
    }
};
export default function COADetails() {
    const { token } = useParams<{ token: string }>();
    const [searchParams] = useSearchParams();
    const { isAuthenticated, isSuperAdmin, client } = useAuth();
    const [hasTracked, setHasTracked] = useState(false);

    const [coa, setCoa] = useState<COA | null>(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');
    const [adminMode, setAdminMode] = useState(false); // Toggle for admin panel
    const [clientEditMode, setClientEditMode] = useState(false); // Toggle for client edit panel

    // Check if current user is the owner of this COA
    const isOwner = isAuthenticated && client && coa?.client_id === client.id;
    const [isDarkMode, setIsDarkMode] = useState(() => {
        // Load preference from localStorage or default to dark
        const saved = localStorage.getItem('coa-theme');
        return saved ? saved === 'dark' : true;
    });
    const qrRef = useRef<HTMLDivElement>(null);

    const toggleTheme = () => {
        const newMode = !isDarkMode;
        setIsDarkMode(newMode);
        localStorage.setItem('coa-theme', newMode ? 'dark' : 'light');
    };

    // Theme colors
    const theme = {
        bg: isDarkMode ? '#0a0e1a' : '#f3f4f6',
        cardBg: isDarkMode ? '#111827' : '#ffffff',
        cardBg2: isDarkMode ? '#1f2937' : '#f9fafb',
        border: isDarkMode ? '#374151' : '#d1d5db',
        text: isDarkMode ? '#ffffff' : '#111827',
        textMuted: isDarkMode ? '#d1d5db' : '#6b7280',
        accent: '#10b981', // Green stays the same in both modes
    };

    const loadCOA = () => {
        fetch(`http://localhost:3000/api/v1/coas/${token}`)
            .then(res => {
                if (!res.ok) throw new Error('COA not found');
                return res.json();
            })
            .then(data => {
                setCoa(data.data);
                setLoading(false);
            })
            .catch(err => {
                console.error(err);
                setError('No se encontró el certificado o hubo un error.');
                setLoading(false);
            });
    };

    useEffect(() => {
        loadCOA();
    }, [token]);

    // Track COA access on load
    useEffect(() => {
        if (token && !hasTracked) {
            // Determine access type from URL params
            const src = searchParams.get('src');
            const cvv = searchParams.get('cvv');

            let accessType = 'direct_link';
            let linkSource: string | undefined;

            if (cvv) {
                // Came from CVV verification
                accessType = 'cvv_verification';
            } else if (src) {
                // Came from PDF link
                if (src.startsWith('pdf_')) {
                    accessType = 'pdf_link';
                    linkSource = src.replace('pdf_', ''); // 'pdf_token' -> 'token'
                } else if (src === 'qr') {
                    accessType = 'qr_global';
                }
            }

            trackCOAAccess(token, accessType, linkSource, cvv || undefined);
            setHasTracked(true);
        }
    }, [token, hasTracked, searchParams]);

    const downloadQR = async () => {
        if (qrRef.current) {
            try {
                const dataUrl = await toPng(qrRef.current, { cacheBust: true, backgroundColor: '#ffffff' });
                const link = document.createElement('a');
                link.download = `EUM-QR-${token}.png`;
                link.href = dataUrl;
                link.click();
            } catch (err) {
                console.error("Failed to download QR", err);
            }
        }
    };

    const handleDownloadPDF = async () => {
        try {
            const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000';
            const response = await fetch(`${API_URL}/api/v1/coas/${token}/pdf`);
            if (!response.ok) throw new Error('Error al generar PDF');

            // Track the PDF download
            if (token) {
                trackPDFDownload(token, 'branded');
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `COA_${token}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        } catch (error) {
            console.error('Error downloading PDF:', error);
            alert('Error al descargar el PDF. Por favor intenta de nuevo.');
        }
    };

    if (loading) return (
        <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: theme.bg, color: theme.accent }}>
            <div className="animate-pulse flex flex-col items-center">
                <FlaskConical className="w-10 h-10 mb-2" />
                <span className="text-sm font-medium">Cargando Análisis...</span>
            </div>
        </div>
    );

    if (error || !coa) return (
        <div className="min-h-screen flex flex-col items-center justify-center p-6" style={{ backgroundColor: theme.bg, color: theme.text }}>
            <AlertTriangle className="w-12 h-12 text-red-500 mb-4" />
            <h2 className="text-xl font-bold mb-2">Error</h2>
            <p className="mb-6" style={{ color: theme.textMuted }}>{error}</p>
            <Link to="/" className="flex items-center" style={{ color: theme.accent }}>
                <ChevronLeft className="w-4 h-4 mr-1" /> Volver al inicio
            </Link>
        </div>
    );

    // Format analysis date
    const formatDate = (dateString?: string) => {
        if (!dateString) return 'Fecha Pendiente';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        } catch (e) {
            return dateString; // Return as-is if parsing fails
        }
    };

    // Helper function to check if a cannabinoid is a THC variant
    // All Delta cannabinoids (Δ8, Δ9, Δ10, etc.) and THC variants are considered THC
    const isTHCVariant = (analyte: string): boolean => {
        const upperAnalyte = analyte.toUpperCase();
        // Match: Delta/Δ followed by any number, THC variants, and exclude totals
        return (
            /^Δ\d/.test(analyte) ||                    // Δ8-THC, Δ9-THC, Δ10-THC, etc.
            /^DELTA\s*\d/i.test(analyte) ||            // Delta 8, Delta 9, Delta 10, etc.
            upperAnalyte.includes('THC') ||            // THCA, THCV, THCP, THCB, etc.
            /^D\d+-THC/i.test(analyte)                 // D8-THC, D9-THC format
        ) && !upperAnalyte.startsWith('TOTAL');        // Exclude "Total THC" to avoid double counting
    };

    // Get factor for THC acids (THCA needs 0.877 conversion factor)
    const getTHCFactor = (analyte: string): number => {
        const upperAnalyte = analyte.toUpperCase();
        // THCA, Δ9-THCA, Δ8-THCA, etc. need the decarboxylation factor
        if (upperAnalyte.includes('THCA')) {
            return 0.877;
        }
        return 1.0;
    };

    // Calculations
    const totalCannabinoids = coa.cannabinoids.reduce((acc, c) => acc + parseFloat(c.result_pct), 0).toFixed(2);

    // Calculate Total THC by summing all THC variants (Delta 8, Delta 9, Delta 10, THCA, THCV, etc.)
    const totalTHC = coa.cannabinoids.reduce((acc, c) => {
        if (isTHCVariant(c.analyte)) {
            const value = parseFloat(c.result_pct) || 0;
            const factor = getTHCFactor(c.analyte);
            return acc + (value * factor);
        }
        return acc;
    }, 0).toFixed(2);

    // Mexico THC compliance: must be <= 1%
    const isTHCCompliant = parseFloat(totalTHC) <= 1.0;

    // Find highest non-THC cannabinoid (excluding all THC variants)
    const nonTHCCannabinoids = coa.cannabinoids.filter(c => !isTHCVariant(c.analyte));
    const highestCannabinoid = nonTHCCannabinoids.length > 0
        ? nonTHCCannabinoids.reduce((max, c) =>
            parseFloat(c.result_pct) > parseFloat(max.result_pct) ? c : max
        )
        : null;

    // Chart Data (Top 5 + Others)
    const sortedCannabinoids = [...coa.cannabinoids].sort((a, b) => parseFloat(b.result_pct) - parseFloat(a.result_pct));
    const chartData = sortedCannabinoids.slice(0, 5).map(c => ({
        name: c.analyte,
        value: parseFloat(c.result_pct)
    }));
    if (sortedCannabinoids.length > 5) {
        const others = sortedCannabinoids.slice(5).reduce((acc, c) => acc + parseFloat(c.result_pct), 0);
        chartData.push({ name: 'Otros', value: others });
    }

    const COLORS = ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5', '#94a3b8'];

    return (
        <div
            className="min-h-screen font-sans print:bg-white print:text-black transition-colors duration-300"
            style={{ backgroundColor: theme.bg, color: theme.text }}
        >

            {/* Navbar */}
            <nav
                className="border-b backdrop-blur sticky top-0 z-10 print:hidden transition-colors duration-300"
                style={{
                    backgroundColor: theme.cardBg + 'cc',
                    borderColor: theme.border
                }}
            >
                <div className="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
                    <Link to="/" className="transition-colors" style={{ color: theme.textMuted }}>
                        <ChevronLeft className="w-6 h-6" />
                    </Link>
                    <span className="font-bold tracking-wider" style={{ color: theme.accent }}>EUM VERIFIED</span>
                    <div className="flex items-center space-x-3">
                        <button
                            onClick={toggleTheme}
                            className="transition-all hover:scale-110"
                            style={{ color: theme.textMuted }}
                            title={isDarkMode ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro'}
                        >
                            {isDarkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
                        </button>
                        {/* Admin panel button - only for super_admin */}
                        {isSuperAdmin && (
                            <button
                                onClick={() => setAdminMode(!adminMode)}
                                className="transition-colors"
                                style={{ color: adminMode ? theme.accent : theme.textMuted }}
                                title="Panel de Administración"
                            >
                                <Settings className="w-5 h-5" />
                            </button>
                        )}
                        {/* Client edit button - only for COA owners (clients) */}
                        {isOwner && !isSuperAdmin && (
                            <button
                                onClick={() => setClientEditMode(!clientEditMode)}
                                className="transition-colors"
                                style={{ color: clientEditMode ? theme.accent : theme.textMuted }}
                                title="Editar mi Producto"
                            >
                                <Edit3 className="w-5 h-5" />
                            </button>
                        )}
                        {/* Buy holograms button - for authenticated clients */}
                        {isAuthenticated && !isSuperAdmin && (
                            <a
                                href="https://extractoseum.com/products/coa-hologramas-para-analisis-cromatografico"
                                target="_blank"
                                rel="noopener noreferrer"
                                className="transition-colors hover:scale-110"
                                style={{ color: theme.textMuted }}
                                title="Comprar Hologramas"
                            >
                                <ShoppingCart className="w-5 h-5" />
                            </a>
                        )}
                        {/* Dashboard link for authenticated users */}
                        {isAuthenticated && (
                            <Link
                                to="/dashboard"
                                className="transition-colors hover:scale-110"
                                style={{ color: theme.textMuted }}
                                title="Mi Dashboard"
                            >
                                <User className="w-5 h-5" />
                            </Link>
                        )}
                        <button
                            onClick={handleDownloadPDF}
                            className="transition-colors hover:scale-110"
                            style={{ color: theme.accent }}
                            title="Descargar PDF Certificado"
                        >
                            <Download className="w-5 h-5" />
                        </button>
                    </div>
                </div>
            </nav>

            <main className="max-w-4xl mx-auto p-4 space-y-6 print:space-y-4">

                {/* Header Card */}
                <div
                    className="rounded-2xl p-6 border shadow-xl relative overflow-hidden print:border-none print:shadow-none print:p-0 transition-colors duration-300"
                    style={{ backgroundColor: theme.cardBg, borderColor: theme.border }}
                >
                    <div className="absolute top-0 right-0 p-4 opacity-30 print:hidden">
                        <ShieldCheck className="w-24 h-24" style={{ color: theme.accent + '30' }} />
                    </div>

                    <div className="relative z-10">
                        <div className="flex items-center space-x-2 mb-2">
                            <span
                                className="px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wide print:border print:border-black print:text-black print:bg-transparent"
                                style={{
                                    backgroundColor: coa.compliance_status === 'pass' ? theme.accent + '30' : '#ef4444' + '30',
                                    color: coa.compliance_status === 'pass' ? theme.accent : '#ef4444'
                                }}
                            >
                                {coa.compliance_status === 'pass' ? 'TESTED' : (coa.compliance_status || 'UNKNOWN').toUpperCase()}
                            </span>
                            {isTHCCompliant && (
                                <span
                                    className="px-2 py-0.5 rounded text-xs border print:text-black print:border-black print:bg-transparent"
                                    style={{
                                        backgroundColor: theme.accent + '20',
                                        color: theme.accent,
                                        borderColor: theme.accent
                                    }}
                                >
                                    THC Compliant (≤1%)
                                </span>
                            )}
                            {!isTHCCompliant && (
                                <span
                                    className="px-2 py-0.5 rounded text-xs border print:text-black print:border-black print:bg-transparent"
                                    style={{
                                        backgroundColor: '#ef4444' + '20',
                                        color: '#ef4444',
                                        borderColor: '#ef4444'
                                    }}
                                >
                                    THC &gt;1% (No Compliant MX)
                                </span>
                            )}
                        </div>

                        <h1 className="text-3xl font-bold mb-2 print:text-black" style={{ color: theme.text }}>
                            {coa.custom_name || coa.product_sku || coa.batch_id || 'Certificado de Análisis'}
                        </h1>
                        <p className="text-sm flex items-center mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>
                            <Calendar className="w-3.5 h-3.5 mr-1.5" />
                            {formatDate(coa.analysis_date)} • {coa.lab_name}
                        </p>
                        <p className="text-xs mb-6 print:text-gray-500" style={{ color: theme.textMuted }}>
                            COA: {coa.coa_number || `EUM_${String(coa.id).slice(0, 8).toUpperCase()}_COA`} • Token: {token}
                        </p>

                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div
                                className="p-4 rounded-xl border print:border-gray-300 print:bg-gray-100 transition-colors duration-300"
                                style={{ backgroundColor: theme.cardBg2, borderColor: theme.border }}
                            >
                                <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Total Cannabinoides</span>
                                <span className="text-2xl font-bold print:text-black" style={{ color: theme.accent }}>{totalCannabinoids}%</span>
                            </div>
                            <div
                                className="p-4 rounded-xl border print:border-gray-300 print:bg-gray-100 transition-colors duration-300"
                                style={{ backgroundColor: theme.cardBg2, borderColor: theme.border }}
                            >
                                <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Total THC</span>
                                <span className="text-2xl font-bold print:text-black" style={{ color: theme.accent }}>{totalTHC}%</span>
                            </div>
                            {highestCannabinoid && (
                                <div
                                    className="p-4 rounded-xl border print:border-gray-300 print:bg-gray-100 transition-colors duration-300"
                                    style={{ backgroundColor: theme.cardBg2, borderColor: theme.border }}
                                >
                                    <span className="text-xs block mb-1 print:text-gray-600 truncate" style={{ color: theme.textMuted }} title={highestCannabinoid.analyte}>
                                        {highestCannabinoid.analyte.length > 15 ? highestCannabinoid.analyte.substring(0, 15) + '...' : highestCannabinoid.analyte}
                                    </span>
                                    <span className="text-2xl font-bold print:text-black" style={{ color: theme.accent }}>{highestCannabinoid.result_pct}%</span>
                                </div>
                            )}
                            <div
                                className="p-4 rounded-xl border print:border-gray-300 print:bg-gray-100 flex flex-col justify-center items-center cursor-pointer group transition-colors duration-300"
                                style={{ backgroundColor: theme.cardBg2, borderColor: theme.border }}
                                onClick={downloadQR}
                            >
                                <div ref={qrRef} className="bg-white p-2 rounded mb-2">
                                    <QRCode value={`https://coa.extractoseum.com/coa/${token}`} size={48} viewBox={`0 0 256 256`} />
                                </div>
                                <span className="text-[10px] flex items-center print:hidden" style={{ color: theme.textMuted }}>
                                    <Download className="w-3 h-3 mr-1" /> Descargar QR
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Watermark Background (if exists) */}
                {coa.watermark_url && (
                    <div className="fixed inset-0 flex items-center justify-center pointer-events-none print:absolute print:opacity-10 hidden print:block">
                        <img
                            src={coa.watermark_url}
                            alt="Watermark"
                            className="max-w-md opacity-5 print:opacity-10"
                        />
                    </div>
                )}

                {/* Product Description */}
                {(coa.metadata?.description_short || coa.metadata?.description_extended) && (
                    <div
                        className="rounded-2xl border p-6 print:border-none print:shadow-none transition-colors duration-300"
                        style={{ backgroundColor: theme.cardBg, borderColor: theme.border }}
                    >
                        {coa.metadata?.description_short && (
                            <div className="mb-4">
                                <h3 className="font-semibold mb-2 print:text-black" style={{ color: theme.accent }}>Descripción del Producto</h3>
                                <p className="leading-relaxed print:text-black" style={{ color: theme.text }}>{coa.metadata.description_short}</p>
                            </div>
                        )}
                        {coa.metadata?.description_extended && (
                            <div>
                                {coa.metadata?.description_short && <h4 className="font-medium mb-2 print:text-gray-700" style={{ color: theme.textMuted }}>Información Detallada</h4>}
                                <p className="leading-relaxed whitespace-pre-line print:text-gray-800" style={{ color: theme.textMuted }}>{coa.metadata.description_extended}</p>
                            </div>
                        )}
                    </div>
                )}

                {/* Extended Information - 2 Column Layout */}
                {(coa.product_image_url || coa.metadata?.client_name || coa.metadata?.received_date) && (
                    <div
                        className="rounded-2xl border p-6 print:border-none print:shadow-none transition-colors duration-300"
                        style={{ backgroundColor: theme.cardBg, borderColor: theme.border }}
                    >
                        <div className="grid md:grid-cols-2 gap-6">
                            {/* Left Column: Technical Details */}
                            <div className="space-y-4">
                                <h3 className="font-semibold mb-4 print:text-black" style={{ color: theme.text }}>Información de la Muestra</h3>

                                {coa.metadata?.client_name && (
                                    <div>
                                        <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Cliente</span>
                                        <span className="print:text-black" style={{ color: theme.text }}>{coa.metadata.client_name}</span>
                                    </div>
                                )}

                                {coa.metadata?.client_reference && (
                                    <div>
                                        <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Referencia del Cliente</span>
                                        <span className="print:text-black" style={{ color: theme.text }}>{coa.metadata.client_reference}</span>
                                    </div>
                                )}

                                {coa.metadata?.received_date && (
                                    <div>
                                        <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Fecha de Recepción</span>
                                        <span className="print:text-black" style={{ color: theme.text }}>
                                            {new Date(coa.metadata.received_date).toLocaleDateString('es-MX')}
                                        </span>
                                    </div>
                                )}

                                {coa.metadata?.sample_condition && (
                                    <div>
                                        <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Condición de Muestra</span>
                                        <span className="print:text-black" style={{ color: theme.text }}>{coa.metadata.sample_condition}</span>
                                    </div>
                                )}

                                {coa.metadata?.storage_temp && (
                                    <div>
                                        <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Temperatura de Almacenamiento</span>
                                        <span className="print:text-black" style={{ color: theme.text }}>{coa.metadata.storage_temp}</span>
                                    </div>
                                )}

                                {coa.metadata?.storage_time && (
                                    <div>
                                        <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Tiempo de Almacenamiento</span>
                                        <span className="print:text-black" style={{ color: theme.text }}>{coa.metadata.storage_time}</span>
                                    </div>
                                )}

                                {coa.metadata?.container_type && (
                                    <div>
                                        <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Tipo de Recipiente</span>
                                        <span className="print:text-black" style={{ color: theme.text }}>{coa.metadata.container_type}</span>
                                    </div>
                                )}

                                {coa.metadata?.batch_number && (
                                    <div>
                                        <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Batch</span>
                                        <span className="print:text-black" style={{ color: theme.text }}>{coa.metadata.batch_number}</span>
                                    </div>
                                )}

                                {/* Sample Weight or Total Potency */}
                                {(coa.metadata?.sample_weight || coa.metadata?.is_total_potency) && (
                                    <div>
                                        <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Peso de Muestra</span>
                                        <span className="print:text-black font-medium" style={{ color: '#10b981' }}>
                                            {coa.metadata?.is_total_potency ? 'Potencia Total' : coa.metadata?.sample_weight}
                                        </span>
                                    </div>
                                )}
                            </div>

                            {/* Right Column: Product Image */}
                            {coa.product_image_url && (
                                <div className="flex items-center justify-center">
                                    <div className="relative">
                                        <img
                                            src={coa.product_image_url}
                                            alt="Product"
                                            className="max-h-64 rounded-lg border-2 shadow-lg print:border-gray-400"
                                            style={{ borderColor: theme.border }}
                                        />
                                        <span className="absolute -bottom-6 left-0 right-0 text-center text-xs print:text-gray-600" style={{ color: theme.textMuted }}>
                                            Imagen del Producto
                                        </span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                )}

                <div className="grid md:grid-cols-2 gap-6 print:block">
                    {/* Chart */}
                    <div
                        className="rounded-2xl border p-6 flex flex-col items-center justify-center print:border-none print:shadow-none transition-colors duration-300"
                        style={{ backgroundColor: theme.cardBg, borderColor: theme.border }}
                    >
                        <h3 className="text-sm font-medium mb-4 self-start" style={{ color: theme.textMuted }}>Perfil de Cannabinoides</h3>
                        <div className="w-full h-64">
                            <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie
                                        data={chartData}
                                        cx="50%"
                                        cy="50%"
                                        innerRadius={60}
                                        outerRadius={80}
                                        paddingAngle={5}
                                        dataKey="value"
                                    >
                                        {chartData.map((_entry, index) => (
                                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} stroke="none" />
                                        ))}
                                    </Pie>
                                    <ReTooltip
                                        contentStyle={{ backgroundColor: theme.cardBg2, border: 'none', borderRadius: '8px', color: theme.text }}
                                        itemStyle={{ color: theme.text }}
                                    />
                                    <Legend verticalAlign="bottom" height={36} iconType="circle" />
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                    </div>

                    {/* Cannabinoids Table */}
                    <div
                        className="rounded-2xl border overflow-hidden print:border print:border-gray-300 print:mt-4 transition-colors duration-300"
                        style={{ backgroundColor: theme.cardBg, borderColor: theme.border }}
                    >
                        <div
                            className="px-6 py-4 border-b flex justify-between items-center print:bg-gray-100 print:border-gray-300 transition-colors duration-300"
                            style={{ backgroundColor: theme.cardBg2, borderColor: theme.border }}
                        >
                            <h3 className="font-semibold flex items-center print:text-black" style={{ color: theme.text }}>
                                <FlaskConical className="w-4 h-4 mr-2 print:text-black" style={{ color: theme.accent }} />
                                Resultados Detallados
                            </h3>
                        </div>

                        <div className="divide-y print:divide-gray-300" style={{ borderColor: theme.border }}>
                            {coa.cannabinoids.map((c, idx) => (
                                <div
                                    key={idx}
                                    className="flex justify-between items-center px-6 py-4 transition-colors print:hover:bg-transparent"
                                    style={{ borderColor: theme.border }}
                                >
                                    <div className="flex flex-col">
                                        <span className="font-medium print:text-black" style={{ color: theme.text }}>{c.analyte}</span>
                                        {c.detected && <span className="text-xs print:text-gray-600" style={{ color: theme.accent + 'cc' }}>Detectado</span>}
                                    </div>
                                    <div className="text-right">
                                        <span className="block text-lg font-bold print:text-black" style={{ color: theme.text }}>
                                            {c.result_pct}%
                                        </span>
                                        {c.result_mg_g && (
                                            <span className="block text-xs print:text-gray-600" style={{ color: theme.textMuted }}>
                                                {c.result_mg_g} mg/g
                                            </span>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>

                {/* Chromatogram Section */}
                {coa.cannabinoids?.some((c: any) => c.retention_time !== undefined && c.area !== undefined && c.area > 0) && (
                    <div
                        className="rounded-2xl border p-6 print:border print:border-gray-300 transition-colors duration-300"
                        style={{ backgroundColor: theme.cardBg, borderColor: theme.border }}
                    >
                        <h3 className="font-semibold mb-4 flex items-center print:text-black" style={{ color: theme.text }}>
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" style={{ color: theme.accent }}>
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            Cromatograma y Resultados
                        </h3>
                        <div className="rounded-lg overflow-hidden border" style={{ borderColor: theme.border }}>
                            <img
                                src={`http://localhost:3000/api/v1/coas/${token}/chromatogram`}
                                alt="Cromatograma"
                                className="w-full h-auto"
                                style={{ backgroundColor: '#ffffff' }}
                                onError={(e) => {
                                    // Hide if chromatogram fails to load
                                    (e.target as HTMLImageElement).parentElement!.parentElement!.style.display = 'none';
                                }}
                            />
                        </div>

                        {/* Peaks Table - Integration Results */}
                        <div className="mt-6">
                            <h4 className="text-sm font-semibold mb-3 print:text-black" style={{ color: theme.text }}>
                                Resultados de Integración
                            </h4>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead>
                                        <tr style={{ backgroundColor: theme.cardBg2 }}>
                                            <th className="px-3 py-2 text-left font-medium print:text-black" style={{ color: theme.textMuted }}>#</th>
                                            <th className="px-3 py-2 text-left font-medium print:text-black" style={{ color: theme.textMuted }}>Nombre del Pico</th>
                                            <th className="px-3 py-2 text-right font-medium print:text-black" style={{ color: theme.textMuted }}>Ret. Time (min)</th>
                                            <th className="px-3 py-2 text-right font-medium print:text-black" style={{ color: theme.textMuted }}>Área</th>
                                            <th className="px-3 py-2 text-right font-medium print:text-black" style={{ color: theme.textMuted }}>Cantidad (ppm)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y" style={{ borderColor: theme.border }}>
                                        {coa.cannabinoids
                                            .filter((c: any) => c.retention_time !== undefined && c.area !== undefined)
                                            .sort((a: any, b: any) => (a.retention_time || 0) - (b.retention_time || 0))
                                            .map((c: any, idx: number) => (
                                                <tr key={idx} className="hover:opacity-80 transition-opacity">
                                                    <td className="px-3 py-2 print:text-black" style={{ color: theme.textMuted }}>{idx + 1}</td>
                                                    <td className="px-3 py-2 font-medium print:text-black" style={{ color: theme.text }}>{c.analyte}</td>
                                                    <td className="px-3 py-2 text-right font-mono print:text-black" style={{ color: theme.text }}>
                                                        {c.retention_time?.toFixed(3)}
                                                    </td>
                                                    <td className="px-3 py-2 text-right font-mono print:text-black" style={{ color: theme.text }}>
                                                        {c.area?.toFixed(3)}
                                                    </td>
                                                    <td className="px-3 py-2 text-right font-mono print:text-black" style={{ color: theme.accent }}>
                                                        {(parseFloat(c.result_pct) * 10000).toFixed(4)}
                                                    </td>
                                                </tr>
                                            ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Injection Details */}
                        {coa.metadata?.injection_details && Object.keys(coa.metadata.injection_details).length > 0 && (
                            <div className="mt-6 pt-6 border-t" style={{ borderColor: theme.border }}>
                                <h4 className="text-sm font-semibold mb-4 print:text-black" style={{ color: theme.text }}>
                                    Detalles de Inyección
                                </h4>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                    {coa.metadata.injection_details.injection_name && (
                                        <div>
                                            <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Injection Name</span>
                                            <span className="text-sm font-medium print:text-black" style={{ color: theme.text }}>{coa.metadata.injection_details.injection_name}</span>
                                        </div>
                                    )}
                                    {coa.metadata.injection_details.vial_number && (
                                        <div>
                                            <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Vial Number</span>
                                            <span className="text-sm font-medium print:text-black" style={{ color: theme.text }}>{coa.metadata.injection_details.vial_number}</span>
                                        </div>
                                    )}
                                    {coa.metadata.injection_details.injection_type && (
                                        <div>
                                            <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Injection Type</span>
                                            <span className="text-sm font-medium print:text-black" style={{ color: theme.text }}>{coa.metadata.injection_details.injection_type}</span>
                                        </div>
                                    )}
                                    {coa.metadata.injection_details.instrument_method && (
                                        <div>
                                            <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Instrument Method</span>
                                            <span className="text-sm font-medium print:text-black" style={{ color: theme.text }}>{coa.metadata.injection_details.instrument_method}</span>
                                        </div>
                                    )}
                                    {coa.metadata.injection_details.processing_method && (
                                        <div>
                                            <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Processing Method</span>
                                            <span className="text-sm font-medium print:text-black" style={{ color: theme.text }}>{coa.metadata.injection_details.processing_method}</span>
                                        </div>
                                    )}
                                    {coa.metadata.injection_details.injection_datetime && (
                                        <div>
                                            <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Injection Date/Time</span>
                                            <span className="text-sm font-medium print:text-black" style={{ color: theme.text }}>{coa.metadata.injection_details.injection_datetime}</span>
                                        </div>
                                    )}
                                    {coa.metadata.injection_details.run_time && (
                                        <div>
                                            <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Run Time (min)</span>
                                            <span className="text-sm font-medium print:text-black" style={{ color: theme.text }}>{coa.metadata.injection_details.run_time}</span>
                                        </div>
                                    )}
                                    {coa.metadata.injection_details.injection_volume && (
                                        <div>
                                            <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Injection Volume</span>
                                            <span className="text-sm font-medium print:text-black" style={{ color: theme.text }}>{coa.metadata.injection_details.injection_volume}</span>
                                        </div>
                                    )}
                                    {coa.metadata.injection_details.channel && (
                                        <div>
                                            <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Channel</span>
                                            <span className="text-sm font-medium print:text-black" style={{ color: theme.text }}>{coa.metadata.injection_details.channel}</span>
                                        </div>
                                    )}
                                    {coa.metadata.injection_details.wavelength && (
                                        <div>
                                            <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Wavelength</span>
                                            <span className="text-sm font-medium print:text-black" style={{ color: theme.text }}>{coa.metadata.injection_details.wavelength} nm</span>
                                        </div>
                                    )}
                                    {coa.metadata.injection_details.bandwidth && (
                                        <div>
                                            <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Bandwidth</span>
                                            <span className="text-sm font-medium print:text-black" style={{ color: theme.text }}>{coa.metadata.injection_details.bandwidth}</span>
                                        </div>
                                    )}
                                    {coa.metadata.injection_details.dilution_factor && (
                                        <div>
                                            <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Dilution Factor</span>
                                            <span className="text-sm font-medium print:text-black" style={{ color: theme.text }}>{coa.metadata.injection_details.dilution_factor}</span>
                                        </div>
                                    )}
                                    {coa.metadata.injection_details.sample_weight && (
                                        <div>
                                            <span className="text-xs block mb-1 print:text-gray-600" style={{ color: theme.textMuted }}>Sample Weight</span>
                                            <span className="text-sm font-medium print:text-black" style={{ color: theme.text }}>{coa.metadata.injection_details.sample_weight}</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        <p className="text-xs mt-4 print:text-gray-600" style={{ color: theme.textMuted }}>
                            Gráfico generado a partir de los datos de integración del análisis cromatográfico HPLC.
                        </p>
                    </div>
                )}

                {/* Purchase Links */}
                {coa.purchase_links && coa.purchase_links.length > 0 && (
                    <div
                        className="rounded-2xl border p-6 print:border print:border-gray-300 transition-colors duration-300"
                        style={{ backgroundColor: theme.cardBg, borderColor: theme.border }}
                    >
                        <h3 className="font-semibold mb-4 print:text-black" style={{ color: theme.text }}>¿Dónde Encontrar?</h3>
                        <div className="flex flex-wrap gap-3">
                            {coa.purchase_links.map((link, idx) => {
                                // Ensure URL has protocol
                                const url = link.url.match(/^https?:\/\//) ? link.url : `https://${link.url}`;
                                return (
                                    <a
                                        key={idx}
                                        href={url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        onClick={() => token && trackLinkClick(token, 'purchase', url, link.label)}
                                        className="flex items-center px-4 py-2 rounded-lg transition-colors print:bg-white print:text-black print:border print:border-black"
                                        style={{
                                            backgroundColor: theme.accent,
                                            color: '#ffffff'
                                        }}
                                    >
                                        🛒 {link.label}
                                    </a>
                                );
                            })}
                        </div>
                    </div>
                )}

                {/* Additional Documents */}
                {coa.additional_docs && coa.additional_docs.length > 0 && (
                    <div
                        className="rounded-2xl border p-6 print:border print:border-gray-300 transition-colors duration-300"
                        style={{ backgroundColor: theme.cardBg, borderColor: theme.border }}
                    >
                        <h3 className="font-semibold mb-4 print:text-black" style={{ color: theme.text }}>Documentación Adicional</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {coa.additional_docs.map((doc, idx) => (
                                <a
                                    key={idx}
                                    href={doc.url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    onClick={() => token && trackLinkClick(token, 'document', doc.url, doc.filename)}
                                    className="flex items-center justify-between p-3 rounded-lg border transition-colors print:bg-white print:text-black print:border-black"
                                    style={{
                                        backgroundColor: theme.cardBg2,
                                        borderColor: theme.border
                                    }}
                                >
                                    <div className="flex items-center">
                                        <FileText className="w-5 h-5 mr-2 print:text-black" style={{ color: theme.accent }} />
                                        <div>
                                            <span className="font-medium print:text-black" style={{ color: theme.text }}>{doc.type}</span>
                                            <span className="text-xs block print:text-gray-600" style={{ color: theme.textMuted }}>{doc.filename}</span>
                                        </div>
                                    </div>
                                    <Download className="w-4 h-4 print:hidden" style={{ color: theme.textMuted }} />
                                </a>
                            ))}
                        </div>
                    </div>
                )}

                {/* Badges */}
                {coa.badges && coa.badges.length > 0 && (
                    <div
                        className="rounded-2xl border p-6 print:border-none transition-colors duration-300"
                        style={{ backgroundColor: theme.cardBg, borderColor: theme.border }}
                    >
                        <h3 className="font-semibold mb-4 text-center print:text-black" style={{ color: theme.text }}>Certificaciones</h3>
                        <div className="flex flex-wrap items-center justify-center gap-6">
                            {coa.badges.map((badge, idx) => (
                                <div key={idx} className="flex flex-col items-center">
                                    <img
                                        src={badge.image_url}
                                        alt={badge.name}
                                        className="max-h-16 object-contain"
                                        title={badge.description || badge.name}
                                    />
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* Admin Panel - CVV Generator (Super Admin only) */}
                {adminMode && token && isSuperAdmin && (
                    <>
                        <CVVGenerator token={token} isDarkMode={isDarkMode} />
                        <COAEnrichmentForm coaToken={token} coa={coa} onComplete={loadCOA} isDarkMode={isDarkMode} />
                    </>
                )}

                {/* Client Edit Panel - Limited fields for COA owners */}
                {clientEditMode && token && isOwner && (
                    <ClientCOAEditor
                        coaToken={token}
                        coa={coa}
                        onComplete={() => {
                            loadCOA();
                            setClientEditMode(false);
                        }}
                        isDarkMode={isDarkMode}
                    />
                )}

                {/* Footer Actions */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 print:hidden">
                    <div className="flex flex-col gap-3">
                        {(coa.metadata?.file_urls || (coa.pdf_url_original ? [coa.pdf_url_original] : [])).map((url, idx) => {
                            // Fallback name logic
                            let label = `PDF Original`;
                            if (coa.metadata?.file_urls && coa.metadata.file_urls.length > 1) {
                                label = coa.metadata?.original_filenames?.[idx] || `Parte ${idx + 1}`;
                            }

                            return (
                                <a
                                    key={idx}
                                    href={url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="flex items-center justify-center py-4 rounded-xl transition-colors border font-medium"
                                    style={{
                                        backgroundColor: theme.cardBg2,
                                        color: theme.text,
                                        borderColor: theme.border
                                    }}
                                >
                                    <FileText className="w-5 h-5 mr-2" /> {label}
                                </a>
                            );
                        })}
                    </div>

                    <button
                        onClick={handleDownloadPDF}
                        className="flex items-center justify-center py-4 rounded-xl transition-colors shadow-lg font-medium h-full min-h-[60px]"
                        style={{
                            backgroundColor: theme.accent,
                            color: '#ffffff'
                        }}
                    >
                        <Download className="w-5 h-5 mr-2" /> Descargar Certificado PDF
                    </button>
                </div>

            </main>
        </div>
    );
}
