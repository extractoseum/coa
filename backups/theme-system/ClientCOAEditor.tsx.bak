import { useState } from 'react';
import { Save, Loader2, Image, FileText, Link as LinkIcon, X, Plus, EyeOff, Eye } from 'lucide-react';
import { authFetch } from '../contexts/AuthContext';

interface ClientCOAEditorProps {
    coaToken: string;
    coa: any;
    onComplete: () => void;
    isDarkMode: boolean;
}

// Fields that clients can edit
const CLIENT_EDITABLE_FIELDS = [
    'product_image_url',
    'short_description',
    'long_description',
    'custom_title',
    'purchase_links',
    'additional_docs',
    'is_hidden'
];

export default function ClientCOAEditor({ coaToken, coa, onComplete, isDarkMode }: ClientCOAEditorProps) {
    const [saving, setSaving] = useState(false);
    const [error, setError] = useState('');
    const [success, setSuccess] = useState('');

    // Form state
    const [customTitle, setCustomTitle] = useState(coa?.custom_title || '');
    const [shortDescription, setShortDescription] = useState(coa?.short_description || '');
    const [longDescription, setLongDescription] = useState(coa?.long_description || '');
    const [productImageUrl, setProductImageUrl] = useState(coa?.product_image_url || '');
    const [isHidden, setIsHidden] = useState(coa?.is_hidden || false);
    const [purchaseLinks, setPurchaseLinks] = useState<{ label: string; url: string }[]>(
        coa?.purchase_links || []
    );
    const [additionalDocs, setAdditionalDocs] = useState<{ type: string; url: string; filename: string }[]>(
        coa?.additional_docs || []
    );

    const theme = {
        bg: isDarkMode ? '#111827' : '#ffffff',
        cardBg: isDarkMode ? '#1f2937' : '#f9fafb',
        border: isDarkMode ? '#374151' : '#d1d5db',
        text: isDarkMode ? '#ffffff' : '#111827',
        textMuted: isDarkMode ? '#9ca3af' : '#6b7280',
        accent: '#10b981',
    };

    const handleSave = async () => {
        setSaving(true);
        setError('');
        setSuccess('');

        try {
            const res = await authFetch(`http://localhost:3000/api/v1/coas/${coaToken}`, {
                method: 'PUT',
                body: JSON.stringify({
                    custom_title: customTitle,
                    short_description: shortDescription,
                    long_description: longDescription,
                    product_image_url: productImageUrl,
                    is_hidden: isHidden,
                    purchase_links: purchaseLinks.filter(l => l.label && l.url),
                    additional_docs: additionalDocs.filter(d => d.type && d.url)
                })
            });

            const data = await res.json();

            if (data.success) {
                setSuccess('Cambios guardados correctamente');
                onComplete();
            } else {
                setError(data.error || 'Error al guardar cambios');
            }
        } catch (err) {
            console.error('Error saving:', err);
            setError('Error de conexion');
        } finally {
            setSaving(false);
        }
    };

    const addPurchaseLink = () => {
        setPurchaseLinks([...purchaseLinks, { label: '', url: '' }]);
    };

    const removePurchaseLink = (index: number) => {
        setPurchaseLinks(purchaseLinks.filter((_, i) => i !== index));
    };

    const updatePurchaseLink = (index: number, field: 'label' | 'url', value: string) => {
        const updated = [...purchaseLinks];
        updated[index][field] = value;
        setPurchaseLinks(updated);
    };

    const addDocument = () => {
        setAdditionalDocs([...additionalDocs, { type: '', url: '', filename: '' }]);
    };

    const removeDocument = (index: number) => {
        setAdditionalDocs(additionalDocs.filter((_, i) => i !== index));
    };

    const updateDocument = (index: number, field: 'type' | 'url' | 'filename', value: string) => {
        const updated = [...additionalDocs];
        updated[index][field] = value;
        setAdditionalDocs(updated);
    };

    return (
        <div
            className="rounded-2xl border p-6 transition-colors duration-300"
            style={{ backgroundColor: theme.bg, borderColor: theme.border }}
        >
            <h3 className="font-semibold mb-4 flex items-center" style={{ color: theme.text }}>
                <FileText className="w-5 h-5 mr-2" style={{ color: theme.accent }} />
                Editar Informacion del Producto
            </h3>

            <p className="text-sm mb-6" style={{ color: theme.textMuted }}>
                Como propietario de este COA, puedes personalizar la informacion del producto.
            </p>

            {error && (
                <div className="bg-red-500/20 border border-red-500/50 text-red-300 px-4 py-3 rounded-lg text-sm mb-4">
                    {error}
                </div>
            )}

            {success && (
                <div className="bg-green-500/20 border border-green-500/50 text-green-300 px-4 py-3 rounded-lg text-sm mb-4">
                    {success}
                </div>
            )}

            <div className="space-y-6">
                {/* Custom Title */}
                <div>
                    <label className="block text-sm mb-2" style={{ color: theme.textMuted }}>
                        Titulo Personalizado
                    </label>
                    <input
                        type="text"
                        value={customTitle}
                        onChange={(e) => setCustomTitle(e.target.value)}
                        placeholder="Ej: CBD Premium Oil 1000mg"
                        className="w-full px-4 py-3 rounded-lg border focus:outline-none focus:ring-2 focus:ring-emerald-500"
                        style={{
                            backgroundColor: theme.cardBg,
                            borderColor: theme.border,
                            color: theme.text
                        }}
                    />
                </div>

                {/* Product Image URL */}
                <div>
                    <label className="block text-sm mb-2 flex items-center" style={{ color: theme.textMuted }}>
                        <Image className="w-4 h-4 mr-1" />
                        URL de Imagen del Producto
                    </label>
                    <input
                        type="url"
                        value={productImageUrl}
                        onChange={(e) => setProductImageUrl(e.target.value)}
                        placeholder="https://ejemplo.com/imagen.jpg"
                        className="w-full px-4 py-3 rounded-lg border focus:outline-none focus:ring-2 focus:ring-emerald-500"
                        style={{
                            backgroundColor: theme.cardBg,
                            borderColor: theme.border,
                            color: theme.text
                        }}
                    />
                    {productImageUrl && (
                        <div className="mt-2">
                            <img
                                src={productImageUrl}
                                alt="Preview"
                                className="max-h-32 rounded-lg border"
                                style={{ borderColor: theme.border }}
                                onError={(e) => (e.target as HTMLImageElement).style.display = 'none'}
                            />
                        </div>
                    )}
                </div>

                {/* Short Description */}
                <div>
                    <label className="block text-sm mb-2" style={{ color: theme.textMuted }}>
                        Descripcion Corta
                    </label>
                    <textarea
                        value={shortDescription}
                        onChange={(e) => setShortDescription(e.target.value)}
                        placeholder="Breve descripcion del producto..."
                        rows={2}
                        className="w-full px-4 py-3 rounded-lg border focus:outline-none focus:ring-2 focus:ring-emerald-500 resize-none"
                        style={{
                            backgroundColor: theme.cardBg,
                            borderColor: theme.border,
                            color: theme.text
                        }}
                    />
                </div>

                {/* Long Description */}
                <div>
                    <label className="block text-sm mb-2" style={{ color: theme.textMuted }}>
                        Descripcion Detallada
                    </label>
                    <textarea
                        value={longDescription}
                        onChange={(e) => setLongDescription(e.target.value)}
                        placeholder="Descripcion completa del producto, ingredientes, uso recomendado..."
                        rows={4}
                        className="w-full px-4 py-3 rounded-lg border focus:outline-none focus:ring-2 focus:ring-emerald-500 resize-none"
                        style={{
                            backgroundColor: theme.cardBg,
                            borderColor: theme.border,
                            color: theme.text
                        }}
                    />
                </div>

                {/* Purchase Links */}
                <div>
                    <label className="block text-sm mb-2 flex items-center" style={{ color: theme.textMuted }}>
                        <LinkIcon className="w-4 h-4 mr-1" />
                        Enlaces de Compra
                    </label>
                    <div className="space-y-2">
                        {purchaseLinks.map((link, index) => (
                            <div key={index} className="flex gap-2">
                                <input
                                    type="text"
                                    value={link.label}
                                    onChange={(e) => updatePurchaseLink(index, 'label', e.target.value)}
                                    placeholder="Nombre (ej: Tienda Oficial)"
                                    className="flex-1 px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    style={{
                                        backgroundColor: theme.cardBg,
                                        borderColor: theme.border,
                                        color: theme.text
                                    }}
                                />
                                <input
                                    type="url"
                                    value={link.url}
                                    onChange={(e) => updatePurchaseLink(index, 'url', e.target.value)}
                                    placeholder="https://..."
                                    className="flex-1 px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    style={{
                                        backgroundColor: theme.cardBg,
                                        borderColor: theme.border,
                                        color: theme.text
                                    }}
                                />
                                <button
                                    onClick={() => removePurchaseLink(index)}
                                    className="p-2 rounded-lg hover:bg-red-500/20 transition-colors"
                                    style={{ color: '#ef4444' }}
                                >
                                    <X className="w-5 h-5" />
                                </button>
                            </div>
                        ))}
                        <button
                            onClick={addPurchaseLink}
                            className="flex items-center gap-1 px-3 py-2 rounded-lg border border-dashed hover:border-emerald-500 transition-colors text-sm"
                            style={{ borderColor: theme.border, color: theme.textMuted }}
                        >
                            <Plus className="w-4 h-4" /> Agregar enlace
                        </button>
                    </div>
                </div>

                {/* Visibility Toggle */}
                <div
                    className="p-4 rounded-lg border"
                    style={{
                        backgroundColor: isHidden ? '#7c3aed20' : theme.cardBg,
                        borderColor: isHidden ? '#7c3aed' : theme.border
                    }}
                >
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            {isHidden ? (
                                <EyeOff className="w-5 h-5" style={{ color: '#7c3aed' }} />
                            ) : (
                                <Eye className="w-5 h-5" style={{ color: theme.accent }} />
                            )}
                            <div>
                                <span className="font-medium" style={{ color: theme.text }}>
                                    {isHidden ? 'COA Oculto' : 'COA Publico'}
                                </span>
                                <p className="text-xs" style={{ color: theme.textMuted }}>
                                    {isHidden
                                        ? 'Este COA no aparecera en carpetas publicas'
                                        : 'Este COA es visible en carpetas publicas compartidas'}
                                </p>
                            </div>
                        </div>
                        <button
                            type="button"
                            onClick={() => setIsHidden(!isHidden)}
                            className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 ${
                                isHidden ? 'bg-purple-600' : 'bg-gray-400'
                            }`}
                        >
                            <span
                                className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                                    isHidden ? 'translate-x-6' : 'translate-x-1'
                                }`}
                            />
                        </button>
                    </div>
                </div>

                {/* Additional Documents */}
                <div>
                    <label className="block text-sm mb-2 flex items-center" style={{ color: theme.textMuted }}>
                        <FileText className="w-4 h-4 mr-1" />
                        Documentos Adicionales
                    </label>
                    <div className="space-y-2">
                        {additionalDocs.map((doc, index) => (
                            <div key={index} className="flex gap-2">
                                <input
                                    type="text"
                                    value={doc.type}
                                    onChange={(e) => updateDocument(index, 'type', e.target.value)}
                                    placeholder="Tipo (ej: Ficha Tecnica)"
                                    className="w-1/4 px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    style={{
                                        backgroundColor: theme.cardBg,
                                        borderColor: theme.border,
                                        color: theme.text
                                    }}
                                />
                                <input
                                    type="text"
                                    value={doc.filename}
                                    onChange={(e) => updateDocument(index, 'filename', e.target.value)}
                                    placeholder="Nombre archivo"
                                    className="w-1/4 px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    style={{
                                        backgroundColor: theme.cardBg,
                                        borderColor: theme.border,
                                        color: theme.text
                                    }}
                                />
                                <input
                                    type="url"
                                    value={doc.url}
                                    onChange={(e) => updateDocument(index, 'url', e.target.value)}
                                    placeholder="URL del documento"
                                    className="flex-1 px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    style={{
                                        backgroundColor: theme.cardBg,
                                        borderColor: theme.border,
                                        color: theme.text
                                    }}
                                />
                                <button
                                    onClick={() => removeDocument(index)}
                                    className="p-2 rounded-lg hover:bg-red-500/20 transition-colors"
                                    style={{ color: '#ef4444' }}
                                >
                                    <X className="w-5 h-5" />
                                </button>
                            </div>
                        ))}
                        <button
                            onClick={addDocument}
                            className="flex items-center gap-1 px-3 py-2 rounded-lg border border-dashed hover:border-emerald-500 transition-colors text-sm"
                            style={{ borderColor: theme.border, color: theme.textMuted }}
                        >
                            <Plus className="w-4 h-4" /> Agregar documento
                        </button>
                    </div>
                </div>

                {/* Save Button */}
                <button
                    onClick={handleSave}
                    disabled={saving}
                    className="w-full flex items-center justify-center gap-2 py-3 rounded-lg font-medium transition-colors disabled:opacity-50"
                    style={{ backgroundColor: theme.accent, color: '#ffffff' }}
                >
                    {saving ? (
                        <>
                            <Loader2 className="w-5 h-5 animate-spin" />
                            Guardando...
                        </>
                    ) : (
                        <>
                            <Save className="w-5 h-5" />
                            Guardar Cambios
                        </>
                    )}
                </button>
            </div>
        </div>
    );
}
