<!-- EUM Identity Graph & Behavior Tracking -->
<script>
(function() {
  'use strict';

  // === CONFIGURATION ===
  var EUM_API = 'https://coa.extractoseum.com/api/v1/behavior/track';

  // === SESSION & FINGERPRINT MANAGEMENT ===
  function getSessionId() {
    var sessionId = sessionStorage.getItem('eum_session_id');
    if (!sessionId) {
      sessionId = 'sess_' + Date.now().toString(36) + '_' + Math.random().toString(36).substring(2, 9);
      sessionStorage.setItem('eum_session_id', sessionId);
    }
    return sessionId;
  }

  function getFingerprint() {
    var fp = localStorage.getItem('eum_fingerprint');
    if (!fp) {
      fp = generateFingerprint();
      localStorage.setItem('eum_fingerprint', fp);
    }
    return fp;
  }

  function generateFingerprint() {
    try {
      var canvas = document.createElement('canvas');
      var ctx = canvas.getContext('2d');
      if (ctx) {
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('EUM fingerprint', 2, 2);
      }
      var canvasData = canvas.toDataURL();

      var fp = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        new Date().getTimezoneOffset().toString(),
        canvasData.slice(-50)
      ].join('|');

      var hash = 0;
      for (var i = 0; i < fp.length; i++) {
        hash = ((hash << 5) - hash) + fp.charCodeAt(i);
        hash = hash & hash;
      }
      return 'fp_' + Math.abs(hash).toString(36);
    } catch (e) {
      return 'fp_' + Date.now().toString(36) + Math.random().toString(36).substring(2, 8);
    }
  }

  // === CUSTOMER IDENTIFICATION ===
  var customerEmail = {{ customer.email | json }} || null;
  var customerName = {{ customer.name | json }} || null;

  if (customerEmail && typeof clarity === 'function') {
    clarity('set', 'customUserId', customerEmail);
    if (customerName) clarity('set', 'customer_name', customerName);
  }

  // === CORE TRACKING FUNCTION ===
  function trackEvent(eventType, metadata) {
    var payload = {
      event_type: eventType,
      handle: customerEmail,
      session_id: getSessionId(),
      fingerprint: getFingerprint(),
      url: window.location.href,
      metadata: Object.assign({}, metadata || {}, {
        customer_name: customerName,
        referrer: document.referrer,
        page_title: document.title,
        timestamp: new Date().toISOString()
      })
    };

    fetch(EUM_API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      keepalive: true
    }).catch(function(err) {
      console.warn('[EUM] Track failed:', err);
    });

    if (typeof clarity === 'function') {
      clarity('event', eventType);
    }
  }

  // === PAGE-SPECIFIC TRACKING ===
  var template = {{ template | json }} || '';

  if (template.indexOf('product') !== -1) {
    trackEvent('view_product', {
      product_id: {{ product.id | json }},
      product_title: {{ product.title | json }},
      product_handle: {{ product.handle | json }},
      product_price: {{ product.price | divided_by: 100.0 | json }},
      product_vendor: {{ product.vendor | json }},
      product_type: {{ product.type | json }}
    });
  }

  if (template.indexOf('collection') !== -1) {
    trackEvent('view_collection', {
      collection_id: {{ collection.id | json }},
      collection_title: {{ collection.title | json }},
      collection_handle: {{ collection.handle | json }},
      products_count: {{ collection.products_count | default: 0 | json }}
    });
  }

  if (template.indexOf('search') !== -1) {
    trackEvent('search_view', {
      search_query: {{ search.terms | json }},
      results_count: {{ search.results_count | default: 0 | json }}
    });
  }

  if (template.indexOf('cart') !== -1) {
    trackEvent('view_cart', {
      cart_total: {{ cart.total_price | divided_by: 100.0 | json }},
      items_count: {{ cart.item_count | json }}
    });
  }

  // === ADD TO CART TRACKING ===
  document.addEventListener('submit', function(e) {
    var form = e.target;
    if (form.action && form.action.indexOf('/cart/add') !== -1) {
      var titleEl = document.querySelector('.product__title, .product-title, h1');
      var productTitle = titleEl ? titleEl.textContent.trim() : 'Unknown Product';
      trackEvent('add_to_cart', { product_title: productTitle });
    }
  });

  // AJAX add to cart
  var originalFetch = window.fetch;
  window.fetch = function() {
    var url = arguments[0];
    if (typeof url === 'string' && url.indexOf('/cart/add') !== -1) {
      trackEvent('add_to_cart', { method: 'ajax', url: url });
    }
    return originalFetch.apply(this, arguments);
  };

  // === PAGE VIEW ===
  trackEvent('page_view', {
    template: template,
    shop_name: {{ shop.name | json }}
  });

  // === DEBUG LOG ===
  console.log('[EUM] Tracking initialized', {
    session_id: getSessionId(),
    fingerprint: getFingerprint(),
    customer: customerEmail || 'anonymous'
  });

})();
</script>
