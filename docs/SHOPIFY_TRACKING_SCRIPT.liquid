<!--
  EUM COMPLETE TRACKING SCRIPT FOR SHOPIFY
  =========================================

  Install this in: Online Store > Themes > Edit Code > Layout > theme.liquid
  Place it right before the closing </head> tag

  Also install in: Settings > Checkout > Additional Scripts (for post-purchase tracking)
-->

<!-- EUM Identity Graph & Behavior Tracking -->
<script>
(function() {
  'use strict';

  // === CONFIGURATION ===
  var EUM_API = 'https://coa.extractoseum.com/api/behavior/track';
  var CLARITY_PROJECT_ID = 'uwvz4motxs'; // EXTRACTOS EUM Shopify project

  // === SESSION & FINGERPRINT MANAGEMENT ===
  function getSessionId() {
    var sessionId = sessionStorage.getItem('eum_session_id');
    if (!sessionId) {
      sessionId = 'sess_' + Date.now().toString(36) + '_' + Math.random().toString(36).substring(2, 9);
      sessionStorage.setItem('eum_session_id', sessionId);
    }
    return sessionId;
  }

  function getFingerprint() {
    var fp = localStorage.getItem('eum_fingerprint');
    if (!fp) {
      fp = generateFingerprint();
      localStorage.setItem('eum_fingerprint', fp);
    }
    return fp;
  }

  function generateFingerprint() {
    try {
      var canvas = document.createElement('canvas');
      var ctx = canvas.getContext('2d');
      if (ctx) {
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('EUM fingerprint', 2, 2);
      }
      var canvasData = canvas.toDataURL();

      var fp = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        new Date().getTimezoneOffset().toString(),
        canvasData.slice(-50)
      ].join('|');

      // Simple hash
      var hash = 0;
      for (var i = 0; i < fp.length; i++) {
        hash = ((hash << 5) - hash) + fp.charCodeAt(i);
        hash = hash & hash;
      }
      return 'fp_' + Math.abs(hash).toString(36);
    } catch (e) {
      return 'fp_' + Date.now().toString(36) + Math.random().toString(36).substring(2, 8);
    }
  }

  // === CUSTOMER IDENTIFICATION ===
  var customerEmail = null;
  var customerName = null;

  {% if customer %}
    customerEmail = '{{ customer.email }}';
    customerName = '{{ customer.name | escape }}';

    // Identify in Microsoft Clarity
    if (typeof clarity === 'function') {
      clarity('set', 'customUserId', customerEmail);
      clarity('set', 'customer_name', customerName);
      {% if customer.orders_count %}
        clarity('set', 'orders_count', '{{ customer.orders_count }}');
        clarity('set', '{{ customer.orders_count | plus: 0 | at_least: 1 | divided_by: 1 | times: 0 | plus: customer.orders_count }}' > 0 ? 'returning_customer' : 'new_customer', 'true');
      {% endif %}
    }
  {% endif %}

  // === CORE TRACKING FUNCTION ===
  function trackEvent(eventType, metadata) {
    var payload = {
      event_type: eventType,
      handle: customerEmail,
      session_id: getSessionId(),
      fingerprint: getFingerprint(),
      url: window.location.href,
      metadata: Object.assign({}, metadata || {}, {
        customer_name: customerName,
        referrer: document.referrer,
        page_title: document.title,
        timestamp: new Date().toISOString()
      })
    };

    // Send to EUM API
    fetch(EUM_API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      keepalive: true
    }).catch(function(err) {
      console.warn('[EUM] Track failed:', err);
    });

    // Also send to Clarity as custom event
    if (typeof clarity === 'function') {
      clarity('event', eventType);
      if (metadata && metadata.product_title) {
        clarity('set', 'last_product_viewed', metadata.product_title);
      }
    }
  }

  // === PAGE-SPECIFIC TRACKING ===

  // Product page
  {% if template contains 'product' %}
    trackEvent('view_product', {
      product_id: '{{ product.id }}',
      product_title: '{{ product.title | escape }}',
      product_handle: '{{ product.handle }}',
      product_price: {{ product.price | divided_by: 100.0 }},
      product_vendor: '{{ product.vendor | escape }}',
      product_type: '{{ product.type | escape }}',
      variant_id: '{{ product.selected_or_first_available_variant.id }}',
      variant_title: '{{ product.selected_or_first_available_variant.title | escape }}'
    });
  {% endif %}

  // Collection page
  {% if template contains 'collection' %}
    trackEvent('view_collection', {
      collection_id: '{{ collection.id }}',
      collection_title: '{{ collection.title | escape }}',
      collection_handle: '{{ collection.handle }}',
      products_count: {{ collection.products_count | default: 0 }}
    });
  {% endif %}

  // Search results
  {% if template contains 'search' %}
    trackEvent('search_view', {
      search_query: '{{ search.terms | escape }}',
      results_count: {{ search.results_count | default: 0 }}
    });
  {% endif %}

  // Cart page
  {% if template contains 'cart' %}
    trackEvent('view_cart', {
      cart_total: {{ cart.total_price | divided_by: 100.0 }},
      items_count: {{ cart.item_count }},
      items: [
        {% for item in cart.items %}
        {
          product_id: '{{ item.product_id }}',
          title: '{{ item.title | escape }}',
          quantity: {{ item.quantity }},
          price: {{ item.price | divided_by: 100.0 }}
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    });
  {% endif %}

  // === ADD TO CART TRACKING ===
  document.addEventListener('submit', function(e) {
    var form = e.target;
    if (form.action && form.action.includes('/cart/add')) {
      var productTitle = form.querySelector('[name="product-title"]')?.value
        || document.querySelector('.product__title, .product-title, h1')?.textContent?.trim()
        || 'Unknown Product';

      trackEvent('add_to_cart', {
        product_title: productTitle,
        form_action: form.action
      });
    }
  });

  // AJAX add to cart (for themes using fetch/XHR)
  var originalFetch = window.fetch;
  window.fetch = function() {
    var url = arguments[0];
    if (typeof url === 'string' && url.includes('/cart/add')) {
      trackEvent('add_to_cart', {
        method: 'ajax',
        url: url
      });
    }
    return originalFetch.apply(this, arguments);
  };

  // === PAGE VIEW (for general tracking) ===
  trackEvent('page_view', {
    template: '{{ template }}',
    shop_name: '{{ shop.name | escape }}'
  });

  // === CONSOLE LOG FOR DEBUGGING ===
  console.log('[EUM] Tracking initialized', {
    session_id: getSessionId(),
    fingerprint: getFingerprint(),
    customer: customerEmail || 'anonymous'
  });

})();
</script>
