
import React, { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useTheme } from '../contexts/ThemeContext';
import {
    ArrowLeft, Save, Folder, FileText, Brain, ChevronRight, Check, AlertCircle,
    ChevronDown, Plus, Trash2, Star, CheckSquare, Square, Search, Settings,
    Wrench, MessageCircle, Mail, Globe, Database, FileBox, Activity, Layout,
    ShoppingBag, ShoppingCart, Bell, Truck
} from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import Editor from '@monaco-editor/react';
import * as yaml from 'js-yaml';
import { Screen } from '../telemetry/Screen';

interface FileItem {
    name: string;
    path: string;
}

interface AgentFolder {
    name: string;
    type: 'agent';
    hasIdentity: boolean;
    isActive: boolean;
    files: FileItem[];
}

interface KnowledgeStructure {
    [key: string]: FileItem[] | AgentFolder[];
}

const AdminAIKnowledge = () => {
    const { theme } = useTheme();
    const navigate = useNavigate();
    const token = localStorage.getItem('accessToken');

    const [structure, setStructure] = useState<KnowledgeStructure>({});
    const [selectedFolder, setSelectedFolder] = useState<string | null>(null);
    const [selectedFile, setSelectedFile] = useState<string | null>(null);
    const [fileContent, setFileContent] = useState<string>('');
    const [loading, setLoading] = useState(false);
    const [saving, setSaving] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [successMsg, setSuccessMsg] = useState<string | null>(null);
    const [expandedAgents, setExpandedAgents] = useState<Record<string, boolean>>({});
    const [uploading, setUploading] = useState(false);
    const [toolsRegistry, setToolsRegistry] = useState<any[]>([]);

    // Simulator State
    const [chatMessage, setChatMessage] = useState('');
    const [chatHistory, setChatHistory] = useState<{ role: string, content: string }[]>([]);
    const [chatLoading, setChatLoading] = useState(false);
    const [selectedPersona, setSelectedPersona] = useState<string>('');
    const [editorRef, setEditorRef] = useState<any>(null);
    const [showToolbox, setShowToolbox] = useState(true);
    const [toolSearch, setToolSearch] = useState('');
    const [selectedModel, setSelectedModel] = useState('gpt-4o');
    const [modelStatus, setModelStatus] = useState<Record<string, { status: string, error?: string }>>({});

    const models = [
        // OpenAI (Verified)
        { id: 'gpt-4o', name: 'GPT-4o (Stable)' },
        { id: 'gpt-4o-mini', name: 'GPT-4o Mini (Fast)' },
        { id: 'o1-preview', name: 'OpenAI o1 Preview (Tier Required)' },
        { id: 'o1-mini', name: 'OpenAI o1 Mini (Tier Required)' },

        // Anthropic (Balance Dependent)
        { id: 'claude-3-5-sonnet-20241022', name: 'Claude 3.5 Sonnet v2' },
        { id: 'claude-3-5-haiku-20241022', name: 'Claude 3.5 Haiku' },

        // Google Gemini (Verified in your Project)
        { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash (Futuristic)' },
        { id: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro (Futuristic)' },
        { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash (Stable)' },
        { id: 'gemini-2.0-flash-exp', name: 'Gemini 2.0 Flash (Exp)' },
        { id: 'gemini-3-flash-preview', name: 'Gemini 3 Flash (Preview)' },
        { id: 'gemini-flash-latest', name: 'Gemini 1.5 Flash (Legacy)' }
    ];

    // Fetch structure on load
    useEffect(() => {
        fetchStructure();
        fetchToolsRegistry();
        fetchStatus();
    }, []);

    const fetchStatus = async () => {
        try {
            const res = await fetch('/api/v1/ai/status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                body: JSON.stringify({ models })
            });
            const data = await res.json();
            if (data.success) {
                const statusMap: any = {};
                data.data.forEach((m: any) => {
                    statusMap[m.id] = { status: m.status, error: m.error };
                });
                setModelStatus(statusMap);
            }
        } catch (e) { console.error('Failed to fetch model status'); }
    };

    const fetchToolsRegistry = async () => {
        try {
            const res = await fetch('/api/v1/admin/knowledge/tools-registry', {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await res.json();
            if (data.success) setToolsRegistry(data.data);
        } catch (err) {
            console.error('Error fetching tools registry:', err);
        }
    };

    const fetchStructure = async () => {
        try {
            setLoading(true);
            const res = await fetch('/api/v1/admin/knowledge', {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await res.json();

            if (data.success) {
                setStructure(data.data);
            } else {
                setError(data.error);
            }
        } catch (err) {
            setError('Error al cargar la estructura');
        } finally {
            setLoading(false);
        }
    };

    const handleFileClick = async (folder: string, filename: string) => {
        try {
            setLoading(true);
            // If filename comes from recursive structure like agents/agentName/file.md
            // The API expects :folder/:filename. 
            // If folder is 'agents', filename should be 'agentName/file.md'
            // My UI logic below constructs this correctly.

            setSelectedFolder(folder);
            setSelectedFile(filename);
            setError(null);
            setSuccessMsg(null);

            // Encode slash in filename if necessary, but typically fetch handles it if path param
            // We use wildcard route now on backend, so it should be fine.
            const encodedFilename = encodeURIComponent(filename).replace(/%2F/g, '/'); // Let slash pass?? 
            // Actually router /:folder/* captures tail. Slash is fine.

            // Use /file endpoint with ?path= query param
            const encodedPath = encodeURIComponent(filename);
            const res = await fetch(`/api/v1/admin/knowledge/${folder}/file?path=${encodedPath}`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await res.json();

            if (data.success) {
                setFileContent(data.data.content);
            } else {
                setError(data.error);
            }
        } catch (err) {
            setError('Error al leer el archivo');
        } finally {
            setLoading(false);
        }
    };

    const handleSave = async () => {
        if (!selectedFolder || !selectedFile) return;

        // Basic validation before saving identity.md
        if (selectedFile === 'identity.md') {
            try {
                // Here we could run YAML validation on specific blocks
                console.log('Validating identity.md structure...');
            } catch (err) {
                console.warn('Validation warning:', err);
            }
        }

        try {
            setSaving(true);
            setSuccessMsg(null);
            setError(null);

            const encodedPath = encodeURIComponent(selectedFile);

            const res = await fetch(`/api/v1/admin/knowledge/${selectedFolder}/file?path=${encodedPath}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify({ content: fileContent })
            });

            const data = await res.json();

            if (data.success) {
                setSuccessMsg('Archivo guardado correctamente');
                await fetchStructure(); // Refresh list to show new files
                setTimeout(() => setSuccessMsg(null), 3000);
            } else {
                setError(data.error);
            }
        } catch (err) {
            setError('Error al guardar');
        } finally {
            setSaving(false);
        }
    };

    const toggleAgentExpand = (agentName: string) => {
        setExpandedAgents(prev => ({
            ...prev,
            [agentName]: !prev[agentName]
        }));
    };

    const handleAddNewFile = (folder: string, agentName?: string) => {
        const name = prompt('Nombre del nuevo archivo (ej: reglas.md):');
        if (!name) return;

        const filename = name.endsWith('.md') ? name : `${name}.md`;
        const fullPath = agentName ? `${agentName}/${filename}` : filename;

        setSelectedFolder(folder);
        setSelectedFile(fullPath);
        setFileContent(''); // Start empty
        setError(null);
        setSuccessMsg(`Borrador preparado: ${filename}. No olvides guardar.`);
    };

    const handleSetActiveAgent = async (folder: string, agentName: string) => {
        try {
            const res = await fetch(`/api/v1/admin/knowledge/${folder}/active-agent`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify({ agentName })
            });
            const data = await res.json();
            if (data.success) {
                setSuccessMsg(`Agente ${agentName} seleccionado como activo`);
                await fetchStructure();
                setTimeout(() => setSuccessMsg(null), 3000);
            } else {
                setError(data.error);
            }
        } catch (err) {
            setError('Error al activar agente');
        }
    };

    const handleCreateNewAgent = async (folder: string) => {
        const name = prompt('Nombre del nuevo agente (ej: Ara Sales 2):');
        if (!name) return;

        try {
            const res = await fetch(`/api/v1/admin/knowledge/${folder}/new-agent`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify({ agentName: name })
            });
            const data = await res.json();
            if (data.success) {
                setSuccessMsg(`Agente ${name} creado con éxito`);
                await fetchStructure();
                // Ensure the category and agent folder are expanded
                const agentId = data.data.name;
                setExpandedAgents(prev => ({
                    ...prev,
                    [agentId]: true
                }));
                // Auto-select the newly created identity file
                setSelectedFolder(folder);
                setSelectedFile(`${agentId}/identity.md`);
                // Start empty content for identity.md or fetch if needed
                setFileContent(`# SYSTEM ROLE: ${name}\n\n[8740] Identity description goes here...`);
            } else {
                setError(data.error);
            }
        } catch (err) {
            setError('Error al crear agente');
        }
    };

    const handleMarkAsInstructive = async (folder: string, filePath: string) => {
        if (!window.confirm('¿Deseas marcar este archivo como el instructivo principal? (Se renombrará a identity.md)')) return;

        try {
            setLoading(true);
            const res = await fetch(`/api/v1/admin/knowledge/${folder}/mark-instructive`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify({ path: filePath })
            });

            const data = await res.json();
            if (data.success) {
                setSuccessMsg('Archivo marcado como instructivo principal');
                await fetchStructure();
                // Select the new identity file
                const agentName = filePath.split('/')[0];
                setSelectedFile(`${agentName}/identity.md`);
            } else {
                setError(data.error);
            }
        } catch (err) {
            setError('Error al marcar como instructivo');
        } finally {
            setLoading(false);
        }
    };

    const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>, folder: string, agentName?: string) => {
        const file = e.target.files?.[0];
        if (!file) return;

        try {
            setUploading(true);
            setError(null);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('folder', folder);
            if (agentName) formData.append('agentName', agentName);

            const res = await fetch('/api/v1/admin/knowledge/upload', {
                method: 'POST',
                headers: { Authorization: `Bearer ${token}` },
                body: formData
            });

            const data = await res.json();
            if (data.success) {
                setSuccessMsg('Archivo procesado con éxito');
                await fetchStructure();
                // Select the new file
                setSelectedFolder(folder);
                setSelectedFile(data.data.path.includes('/') ? data.data.path.split('/').slice(1).join('/') : data.data.path);
                // Refresh content
                handleFileClick(folder, data.data.path.includes('/') ? data.data.path.split('/').slice(1).join('/') : data.data.path);
            } else {
                setError(data.error || 'Error al subir archivo');
            }
        } catch (err) {
            setError('Error de conexión al subir');
        } finally {
            setUploading(false);
            if (e.target) e.target.value = ''; // Reset input
        }
    };

    const handleSendMessage = async () => {
        if (!chatMessage.trim()) return;

        const userMsg = chatMessage;
        setChatMessage('');
        setChatHistory(prev => [...prev, { role: 'user', content: userMsg }]);
        setChatLoading(true);

        try {
            const res = await fetch('/api/v1/ai/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify({
                    message: userMsg,
                    persona: selectedPersona, // Pass folder name (e.g. "sales_agent")
                    history: chatHistory,
                    model: selectedModel
                })
            });
            const data = await res.json();

            if (data.success && data.data.content) {
                setChatHistory(prev => [...prev, { role: 'assistant', content: data.data.content }]);
            } else {
                setChatHistory(prev => [...prev, { role: 'system', content: `Error: ${data.error || 'No response'}` }]);
            }
        } catch (err) {
            setChatHistory(prev => [...prev, { role: 'system', content: 'Connection Error' }]);
        } finally {
            setChatLoading(false);
        }
    };

    const folderNames: Record<string, string> = {
        agents_god_mode: 'AGENTS_GOD_MODE',
        agents_public: 'AGENTS_PUBLIC',
        agents_internal: 'AGENTS_INTERNAL',
        instructions: 'INSTRUCCIONES GLOBALES',
        information: 'BASE DE DATOS (CONTEXTO)',
        core: 'CORE'
    };

    const AGENT_FOLDERS = ['agents_god_mode', 'agents_public', 'agents_internal'];

    const handleDeleteFile = async (folder: string, filename: string) => {
        if (!window.confirm(`¿Estás seguro de eliminar ${filename}?`)) return;

        try {
            setLoading(true);
            const encodedPath = encodeURIComponent(filename);
            const res = await fetch(`/api/v1/admin/knowledge/${folder}/file?path=${encodedPath}`, {
                method: 'DELETE',
                headers: { Authorization: `Bearer ${token}` }
            });

            const data = await res.json();
            if (data.success) {
                setSuccessMsg('Archivo eliminado');
                if (selectedFile === filename && selectedFolder === folder) {
                    setSelectedFile(null);
                    setFileContent('');
                }
                await fetchStructure();
            } else {
                setError(data.error);
            }
        } catch (err) {
            setError('Error al eliminar');
        } finally {
            setLoading(false);
        }
    };

    const isAgentFolder = (item: any): item is AgentFolder => {
        return item.type === 'agent';
    };

    return (

        <div className="min-h-screen p-6" style={{ backgroundColor: theme.bg }}>
            {/* Header */}
            <div className="max-w-7xl mx-auto mb-6">
                <button onClick={() => navigate('/')} className="flex items-center gap-2 mb-4 hover:opacity-80 transition-opacity" style={{ color: theme.textMuted }}>
                    <ArrowLeft size={20} /> <span>Volver al Dashboard</span>
                </button>
                <div className="flex items-center gap-3 mb-2">
                    <div className="p-3 rounded-xl bg-pink-500/10">
                        <Brain size={32} className="text-pink-500" />
                    </div>
                    <div>
                        <h1 className="text-2xl font-bold" style={{ color: theme.text }}>Editor de Agentes AI</h1>
                        <p style={{ color: theme.textMuted }}>Diseña, edita y simula el comportamiento de tus agentes inteligentes.</p>
                    </div>
                </div>
            </div>

            <div className="max-w-screen-2xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-4 h-[85vh]">

                {/* Left Sidebar: File Explorer */}
                <div className="lg:col-span-2 rounded-2xl overflow-hidden flex flex-col min-w-0"
                    style={{ backgroundColor: theme.cardBg, border: `1px solid ${theme.border}` }}>
                    <div className="p-4 border-b shrink-0" style={{ borderColor: theme.border }}>
                        <h2 className="font-semibold flex items-center gap-2" style={{ color: theme.text }}>
                            <Folder size={18} /> Estructura
                        </h2>
                    </div>

                    <div className="flex-1 overflow-y-auto p-2 space-y-4">
                        {Object.keys(structure).map(folder => (
                            <div key={folder} className="mb-6">
                                <div className="px-3 py-2 text-xs font-bold uppercase tracking-wider mb-1 opacity-70" style={{ color: theme.textMuted }}>
                                    {folderNames[folder] || folder}
                                </div>

                                {/* Management Buttons - Subtler, standardized style */}
                                {!AGENT_FOLDERS.includes(folder) && (
                                    <div className="flex items-center gap-2 px-3 mb-3">
                                        <button
                                            onClick={() => handleAddNewFile(folder)}
                                            className="flex items-center gap-1 px-2 py-1 text-[10px] opacity-70 hover:opacity-100 hover:text-pink-500 transition-all font-medium"
                                            style={{ color: theme.text }}
                                        >
                                            <Plus size={10} /> Nuevo MD
                                        </button>

                                        <label
                                            className="flex items-center gap-1 px-2 py-1 text-[10px] opacity-70 hover:opacity-100 hover:text-purple-400 cursor-pointer transition-all font-medium"
                                            style={{ color: theme.text }}
                                        >
                                            <input
                                                type="file"
                                                className="hidden"
                                                accept=".pdf,.jpg,.jpeg,.png"
                                                onChange={(e) => handleFileUpload(e, folder)}
                                            />
                                            <Plus size={10} /> Subir PDF/JPG
                                        </label>
                                    </div>
                                )}

                                {AGENT_FOLDERS.includes(folder) ? (
                                    <div className="space-y-1">
                                        {/* Category Management Buttons */}
                                        <div className="flex items-center gap-2 px-3 mb-2">
                                            <button
                                                onClick={() => handleCreateNewAgent(folder)}
                                                className="flex items-center gap-1 px-2 py-1 text-[10px] opacity-70 hover:opacity-100 hover:text-green-500 transition-all font-medium"
                                                style={{ color: theme.text }}
                                            >
                                                <Plus size={10} /> Nuevo Agente
                                            </button>
                                        </div>

                                        {(structure[folder] as AgentFolder[]).map(agent => (
                                            <div key={agent.name} className="ml-1">
                                                <div className="flex items-center group/agent pr-2">
                                                    <button
                                                        onClick={() => toggleAgentExpand(agent.name)}
                                                        className="flex-1 flex items-center gap-2 px-2 py-1.5 rounded hover:bg-white/5 text-sm font-medium transition-colors"
                                                        style={{ color: theme.text }}
                                                    >
                                                        {expandedAgents[agent.name] ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                                                        <span className="flex items-center gap-1">
                                                            <Brain size={14} className={agent.isActive ? "text-pink-500" : "text-gray-400"} />
                                                            <span>{agent.name}</span>
                                                        </span>
                                                    </button>

                                                    {/* Active Toggle (Checkbox) */}
                                                    <button
                                                        onClick={() => handleSetActiveAgent(folder, agent.name)}
                                                        className={`p-1 rounded transition-all ${agent.isActive ? 'text-green-500' : 'text-gray-500 opacity-20 hover:opacity-100'}`}
                                                        title={agent.isActive ? "Agente Activo" : "Marcar como Activo"}
                                                    >
                                                        {agent.isActive ? <CheckSquare size={16} /> : <Square size={16} />}
                                                    </button>
                                                </div>

                                                {(expandedAgents[agent.name] || false) && (
                                                    <div className="ml-6 mt-1 space-y-0.5 border-l border-white/10 pl-2">
                                                        {/* Agent actions inside folder */}
                                                        <div className="flex items-center gap-2 mb-2 px-2">
                                                            <button
                                                                onClick={() => handleAddNewFile(folder, agent.name)}
                                                                className="flex items-center gap-1 px-1 py-0.5 text-[9px] opacity-50 hover:opacity-100 hover:text-pink-500 transition-all"
                                                                style={{ color: theme.text }}
                                                            >
                                                                <Plus size={9} /> Nuevo MD
                                                            </button>
                                                            <label className="flex items-center gap-1 px-1 py-0.5 text-[9px] opacity-50 hover:opacity-100 hover:text-purple-400 cursor-pointer transition-all" style={{ color: theme.text }}>
                                                                <input
                                                                    type="file"
                                                                    className="hidden"
                                                                    accept=".pdf,.jpg,.jpeg,.png"
                                                                    onChange={(e) => handleFileUpload(e, folder, agent.name)}
                                                                />
                                                                <Plus size={9} /> Subir
                                                            </label>
                                                        </div>

                                                        {agent.files.map(file => (
                                                            <div key={file.path} className="group flex items-center justify-between">
                                                                <button
                                                                    onClick={() => handleFileClick(folder, `${agent.name}/${file.name}`)}
                                                                    className={`flex-1 text-left px-2 py-1 rounded text-xs flex items-center gap-2 transition-colors ${selectedFile === `${agent.name}/${file.name}` ? 'bg-pink-500/10 text-pink-500' : 'hover:bg-white/5'}`}
                                                                    style={{ color: selectedFile === `${agent.name}/${file.name}` ? undefined : theme.textMuted }}
                                                                >
                                                                    {file.name === 'identity.md' ? (
                                                                        <Star size={12} className="text-yellow-500 fill-yellow-500" />
                                                                    ) : (
                                                                        <FileText size={12} className="opacity-50" />
                                                                    )}
                                                                    <span className="truncate">{file.name === 'identity.md' ? `${agent.name}_instructive` : file.name}</span>
                                                                </button>
                                                                <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all">
                                                                    {file.name !== 'identity.md' && (
                                                                        <button
                                                                            onClick={(e) => { e.stopPropagation(); handleMarkAsInstructive(folder, `${agent.name}/${file.name}`); }}
                                                                            className="p-1 text-gray-400 hover:text-yellow-500 transition-all opacity-40 group-hover:opacity-100"
                                                                            title="Marcar como Instructivo"
                                                                        >
                                                                            <Star size={14} />
                                                                        </button>
                                                                    )}
                                                                    <button
                                                                        onClick={(e) => { e.stopPropagation(); handleDeleteFile(folder, `${agent.name}/${file.name}`); }}
                                                                        className="p-1 hover:text-red-500 transition-all"
                                                                        title="Eliminar"
                                                                    >
                                                                        <Trash2 size={10} />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="ml-1 mt-1 mb-4">
                                        <div className="space-y-0.5 mt-2">
                                            {((structure[folder] as FileItem[]) || []).length > 0 ? (
                                                (structure[folder] as FileItem[]).map(file => (
                                                    <div key={file.path} className="group flex items-center justify-between">
                                                        <button
                                                            onClick={() => handleFileClick(folder, file.name)}
                                                            className={`flex-1 text-left px-2 py-1.5 rounded text-xs flex items-center gap-2 transition-colors ${selectedFile === file.name && selectedFolder === folder ? 'bg-pink-500/10 text-pink-500' : 'hover:bg-white/5'}`}
                                                            style={{ color: selectedFile === file.name && selectedFolder === folder ? undefined : theme.textMuted }}
                                                        >
                                                            {file.name.includes('INSTRUCTIVO') || folder === 'instructions' ? (
                                                                <Star size={12} className="text-yellow-500 fill-yellow-500" />
                                                            ) : (
                                                                <FileText size={12} className="opacity-50" />
                                                            )}
                                                            <span className="truncate">{file.name}</span>
                                                        </button>
                                                        <button
                                                            onClick={(e) => { e.stopPropagation(); handleDeleteFile(folder, file.name); }}
                                                            className="p-1 opacity-0 group-hover:opacity-100 hover:text-red-500 transition-all text-xs"
                                                            title="Eliminar"
                                                        >
                                                            <Trash2 size={12} />
                                                        </button>
                                                    </div>
                                                ))
                                            ) : (
                                                <div className="px-3 py-4 text-[10px] opacity-20 border border-dashed border-white/5 rounded-lg text-center" style={{ color: theme.text }}>
                                                    Sin contenido en esta categoría
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>

                {/* Editor (Flexible) */}
                <div className="lg:col-span-7 rounded-2xl overflow-hidden flex flex-col min-w-0"
                    style={{ backgroundColor: theme.cardBg, border: `1px solid ${theme.border}` }}>

                    {selectedFile ? (
                        <>
                            <div className="p-4 border-b flex items-center justify-between" style={{ borderColor: theme.border }}>
                                <div className="flex items-center gap-2" style={{ color: theme.text }}>
                                    <Brain size={16} className="text-purple-400" />
                                    <span className="font-medium">{selectedFile}</span>
                                </div>
                                <div className="flex items-center gap-3">
                                    {selectedFolder?.startsWith('agents_') && (
                                        <button
                                            onClick={() => setShowToolbox(!showToolbox)}
                                            className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border transition-all ${showToolbox ? 'bg-purple-500/20 border-purple-500/50 text-purple-300' : 'opacity-70 hover:opacity-100 hover:bg-white/5'}`}
                                            style={{ borderColor: showToolbox ? undefined : theme.border, color: showToolbox ? undefined : theme.text }}
                                            title="Explorar Biblioteca de Herramientas"
                                        >
                                            <Wrench size={14} />
                                            <span className="text-xs font-medium">Biblioteca de Tools</span>
                                        </button>
                                    )}
                                    {error && <span className="text-red-500 text-xs flex items-center gap-1">{error}</span>}
                                    {successMsg && <span className="text-green-500 text-xs flex items-center gap-1">{successMsg}</span>}
                                    <button onClick={handleSave} disabled={saving} className="flex items-center gap-2 px-4 py-2 rounded-lg bg-pink-500 hover:bg-pink-600 text-white font-medium text-sm disabled:opacity-50">
                                        <Save size={16} /> Guardar
                                    </button>
                                </div>
                            </div>
                            <div className="flex-1 relative flex flex-col overflow-hidden">
                                {loading && (
                                    <div className="absolute inset-0 flex items-center justify-center bg-black/10 backdrop-blur-[1px] z-20">
                                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"></div>
                                    </div>
                                )}
                                <div className="flex-1 flex overflow-hidden">
                                    <div className="flex-1 relative">
                                        <Editor
                                            height="100%"
                                            language={selectedFile?.endsWith('.json') ? 'json' : selectedFile?.endsWith('.yaml') ? 'yaml' : 'markdown'}
                                            theme="agentTheme"
                                            value={fileContent}
                                            onChange={(value) => setFileContent(value || '')}
                                            onMount={(editor) => setEditorRef(editor)}
                                            options={{
                                                minimap: { enabled: false },
                                                fontSize: 14,
                                                wordWrap: 'on',
                                                scrollBeyondLastLine: false,
                                                automaticLayout: true,
                                                padding: { top: 0 },
                                                lineNumbers: 'on',
                                                glyphMargin: true,
                                                folding: true,
                                                renderWhitespace: 'selection',
                                                fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
                                                lineDecorationsWidth: 10,
                                                lineNumbersMinChars: 3
                                            }}
                                            beforeMount={(monaco) => {
                                                monaco.editor.defineTheme('agentTheme', {
                                                    base: 'vs-dark',
                                                    inherit: true,
                                                    rules: [
                                                        { token: 'keyword', foreground: 'ec4899', fontStyle: 'bold' },
                                                        { token: 'variable', foreground: 'a855f7' },
                                                        { token: 'string', foreground: '10b981' },
                                                        { token: 'comment', foreground: '6b7280' },
                                                        { token: 'type', foreground: '3b82f6' }
                                                    ],
                                                    colors: {
                                                        'editor.background': '#0f172a',
                                                        'editor.lineHighlightBackground': '#1e293b20',
                                                    }
                                                });
                                            }}
                                        />
                                    </div>

                                    {showToolbox && selectedFolder?.startsWith('agents_') && (
                                        <div className="w-72 border-l overflow-y-auto p-4 flex flex-col gap-4 animate-in slide-in-from-right duration-300 shrink-0"
                                            style={{ backgroundColor: theme.cardBg2, borderColor: theme.border }}>
                                            <div className="flex items-center justify-between">
                                                <h3 className="text-xs font-bold uppercase tracking-wider flex items-center gap-2" style={{ color: theme.textMuted }}>
                                                    <Wrench size={14} /> Toolbox
                                                </h3>
                                                <button onClick={() => setShowToolbox(false)} className="opacity-50 hover:opacity-100"><Plus size={14} className="rotate-45" /></button>
                                            </div>

                                            <div className="space-y-4">
                                                <div className="relative">
                                                    <Search size={12} className="absolute left-2 top-2.5 opacity-30" style={{ color: theme.text }} />
                                                    <input
                                                        type="text"
                                                        placeholder="Buscar tools..."
                                                        value={toolSearch}
                                                        onChange={(e) => setToolSearch(e.target.value)}
                                                        className="w-full bg-black/20 border rounded-lg pl-7 pr-2 py-1.5 text-[10px] outline-none"
                                                        style={{ borderColor: theme.border, color: theme.text }}
                                                    />
                                                </div>

                                                <div className="space-y-2">
                                                    <p className="text-[10px] font-medium opacity-40 uppercase" style={{ color: theme.text }}>Herramientas Disponibles</p>
                                                    {toolsRegistry
                                                        .filter(t => t.name.toLowerCase().includes(toolSearch.toLowerCase()) || (t.description || '').toLowerCase().includes(toolSearch.toLowerCase()))
                                                        .map(tool => {
                                                            const getToolIcon = (category: string) => {
                                                                switch (category) {
                                                                    case 'whatsapp': return <MessageCircle size={10} className="text-green-500" />;
                                                                    case 'mail': return <Mail size={10} className="text-blue-400" />;
                                                                    case 'shopify': return <Globe size={10} className="text-green-400" />;
                                                                    case 'shopping-bag': return <ShoppingBag size={10} className="text-pink-400" />;
                                                                    case 'shopping-cart': return <ShoppingCart size={10} className="text-purple-400" />;
                                                                    case 'bell': return <Bell size={10} className="text-yellow-400" />;
                                                                    case 'truck': return <Truck size={10} className="text-orange-400" />;
                                                                    case 'orders': return <Layout size={10} className="text-indigo-400" />;
                                                                    case 'users': return <Database size={10} className="text-cyan-400" />;
                                                                    case 'system': return <Activity size={10} className="text-red-400" />;
                                                                    case 'files': return <FileBox size={10} className="text-gray-400" />;
                                                                    case 'search': return <Search size={10} className="text-blue-500" />;
                                                                    default: return <Wrench size={10} className="text-pink-500" />;
                                                                }
                                                            };

                                                            return (
                                                                <button
                                                                    key={tool.name}
                                                                    onClick={() => {
                                                                        if (!editorRef) return;
                                                                        const snippet = `\nname: ${tool.name}\nargs:\n${Object.keys(tool.input_schema.properties || {}).map(p => `  ${p}: "{{${p}}}"`).join('\n')}\n`;
                                                                        const selection = editorRef.getSelection();
                                                                        editorRef.executeEdits('toolbox', [{
                                                                            range: selection,
                                                                            text: snippet,
                                                                            forceMoveMarkers: true
                                                                        }]);
                                                                    }}
                                                                    className="w-full text-left p-2 rounded-lg border border-transparent hover:border-pink-500/30 hover:bg-pink-500/5 transition-all group"
                                                                    style={{ color: theme.text }}
                                                                >
                                                                    <div className="flex items-center justify-between mb-1">
                                                                        <div className="flex items-center gap-1.5 min-w-0">
                                                                            {getToolIcon(tool.category || '')}
                                                                            <span className="text-[11px] font-mono text-pink-400 group-hover:text-pink-300 transition-colors uppercase truncate">{tool.name}</span>
                                                                        </div>
                                                                        <Plus size={10} className="opacity-0 group-hover:opacity-100 shrink-0" />
                                                                    </div>
                                                                    <p className="text-[9px] opacity-40 leading-tight group-hover:opacity-70 transition-opacity line-clamp-2">
                                                                        {tool.description}
                                                                    </p>
                                                                </button>
                                                            );
                                                        })}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </>
                    ) : (
                        <div className="flex-1 flex flex-col items-center justify-center text-center opacity-50">
                            <Brain size={48} className="mb-4" />
                            <p>Selecciona un archivo para editar</p>
                        </div>
                    )}
                </div>

                {/* Simulator (Fixed-ish) */}
                <div className="lg:col-span-3 rounded-2xl overflow-hidden flex flex-col min-w-0"
                    style={{ backgroundColor: theme.cardBg, border: `1px solid ${theme.border}` }}>
                    <div className="p-3 border-b flex flex-col gap-2" style={{ borderColor: theme.border }}>
                        <div className="flex justify-between items-center">
                            <h2 className="font-semibold flex items-center gap-2 text-sm" style={{ color: theme.text }}>
                                <Brain size={16} className="text-green-400" /> Simulador de Agente
                            </h2>
                            <button onClick={() => setChatHistory([])} className="text-[10px] uppercase opacity-50 hover:opacity-100">Reset</button>
                        </div>

                        {/* Model Selector with Status */}
                        <div className="flex items-center gap-2 bg-black/20 rounded-lg px-2 py-1.5 border" style={{ borderColor: theme.border }}>
                            <div
                                className="w-2 h-2 rounded-full shrink-0"
                                style={{
                                    backgroundColor: modelStatus[selectedModel]?.status === 'online' ? '#10b981' :
                                        (modelStatus[selectedModel]?.status === 'offline' ? '#ef4444' : '#6b7280')
                                }}
                            />
                            <select
                                value={selectedModel}
                                onChange={(e) => setSelectedModel(e.target.value)}
                                className="bg-transparent text-[10px] outline-none cursor-pointer border-none p-0 flex-1"
                                style={{ color: theme.text }}
                            >
                                {models.map(m => (
                                    <option key={m.id} value={m.id} style={{ backgroundColor: theme.cardBg, color: theme.text }}>
                                        {m.name}
                                    </option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div className="p-2 border-b" style={{ borderColor: theme.border }}>
                        <select
                            className="w-full bg-black/20 border rounded px-2 py-1 text-sm outline-none"
                            style={{ borderColor: theme.border, color: theme.text }}
                            value={selectedPersona}
                            onChange={(e) => setSelectedPersona(e.target.value)}
                        >
                            <option value="">Seleccionar Agente...</option>
                            {/* Dynamically list Agents from all agent categories */}
                            {AGENT_FOLDERS.map(cat =>
                                (structure[cat] as AgentFolder[] || []).map(agent => (
                                    <option key={`${cat}-${agent.name}`} value={agent.name}>
                                        {cat.replace('agents_', '').toUpperCase()}: {agent.name.replace(/_/g, ' ').toUpperCase()}
                                    </option>
                                ))
                            )}
                        </select>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-black/20">
                        {chatHistory.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[90%] p-2 rounded text-xs ${m.role === 'user' ? 'bg-purple-600 text-white' : 'bg-gray-700 text-gray-200'}`}>
                                    {m.content}
                                </div>
                            </div>
                        ))}
                        {chatLoading && <div className="text-xs opacity-50 text-center">Escribiendo...</div>}
                    </div>

                    <div className="p-3 border-t" style={{ borderColor: theme.border }}>
                        <form onSubmit={(e) => { e.preventDefault(); handleSendMessage(); }} className="flex gap-2">
                            <input
                                type="text"
                                value={chatMessage}
                                onChange={(e) => setChatMessage(e.target.value)}
                                placeholder="Probar respuesta..."
                                className="flex-1 bg-transparent border rounded px-2 py-1 text-sm outline-none"
                                style={{ borderColor: theme.border, color: theme.text }}
                            />
                            <button type="submit" disabled={chatLoading} className="p-2 bg-purple-600 rounded text-white"><ChevronRight size={16} /></button>
                        </form>
                    </div>
                </div>

            </div>
        </div>
        </div>

    );
};

export default AdminAIKnowledge;
